
 <!DOCTYPE HTML>
<html lang="Chinese">
<head>
  <meta charset="UTF-8">
  
    <title>NineOldAnimations 设计解析 | Mr.Simple&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Mr.Simple">
    
    <meta name="description" content="NineOldAnimations 设计解析
1. 功能介绍
   NineOldAndroids是一款支持在低版本( api 11以下 )使用Android属性动画以及3D旋转动画的框架，它提供了一系列如ViewAnimator,ObjectAnimator,ViewPropertyAnimato">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.png">
    
    
    <link rel="apple-touch-icon" href="/img/header.png">
    <link rel="apple-touch-icon-precomposed" href="/img/header.png">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/header.png" alt="Mr.Simple&#39;s Blog" title="Mr.Simple&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Mr.Simple&#39;s Blog">Mr.Simple&#39;s Blog</a></h1>
				<h2 class="blog-motto">KEEP IT SIMPLE AND STUPID!</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="http://blog.csdn.net/bboyfeiyu">CSDN Blog</a></li>
					
						<li><a href="https://github.com/bboyfeiyu">Github</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:www.simplecoder.cn">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/12/nineold/" title="NineOldAnimations 设计解析" itemprop="url">NineOldAnimations 设计解析</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://www.simplecoder.cn" title="Mr.Simple">Mr.Simple</a>
    </p>
  <p class="article-time">
    <time datetime="2015-02-12T07:27:44.000Z" itemprop="datePublished">Feb 12 2015</time>
    Updated:<time datetime="2015-02-12T07:41:59.000Z" itemprop="dateModified">Feb 12 2015</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NineOldAnimations_设计解析"><span class="toc-number">1.</span> <span class="toc-text">NineOldAnimations 设计解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-_功能介绍"><span class="toc-number">1.0.1.</span> <span class="toc-text">1. 功能介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-_总体设计"><span class="toc-number">1.0.2.</span> <span class="toc-text">2. 总体设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1_类详细介绍"><span class="toc-number">1.0.3.</span> <span class="toc-text">2.1 类详细介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2_基本使用"><span class="toc-number">1.0.4.</span> <span class="toc-text">2.2 基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-_流程图"><span class="toc-number">1.0.5.</span> <span class="toc-text">3. 流程图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1_ValueAnimator流程图"><span class="toc-number">1.0.5.1.</span> <span class="toc-text">3.1 ValueAnimator流程图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2_View的ObjectAnimator流程图"><span class="toc-number">1.0.5.2.</span> <span class="toc-text">3.2 View的ObjectAnimator流程图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-_详细设计"><span class="toc-number">1.0.6.</span> <span class="toc-text">4. 详细设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1_核心原理分析"><span class="toc-number">1.0.6.1.</span> <span class="toc-text">4.1 核心原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-1_ValueAnimator-java"><span class="toc-number">1.0.6.1.1.</span> <span class="toc-text">4.1.1 ValueAnimator.java</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2_ObjectAnimator-java"><span class="toc-number">1.0.6.1.2.</span> <span class="toc-text">4.1.2 ObjectAnimator.java</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-3_KeyFrameSet-java"><span class="toc-number">1.0.6.1.3.</span> <span class="toc-text">4.1.3  KeyFrameSet.java</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-4_PropertyValuesHolder-java"><span class="toc-number">1.0.6.1.4.</span> <span class="toc-text">4.1.4 PropertyValuesHolder.java</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-_杂谈"><span class="toc-number">1.0.7.</span> <span class="toc-text">5. 杂谈</span></a></li></ol></li></ol></li></ol>
		</div>
		
		<h1 id="NineOldAnimations_设计解析">NineOldAnimations 设计解析</h1>
<h3 id="1-_功能介绍">1. 功能介绍</h3>
<p>   NineOldAndroids是一款支持在低版本( api 11以下 )使用Android属性动画以及3D旋转动画的框架，它提供了一系列如ViewAnimator,ObjectAnimator,ViewPropertyAnimator等API来完成这些动画,解决了Android动画框架在低版本的兼容性问题。在api 11 ( Honeycomb (Android 3.0) )后Android推出了属性动画、X轴翻转等动画效果，但是这些效果却不能运行在api 11以下,NineOldAndroids的出现使得这些动画效果能够兼容低版本系统，保证动画在各个系统版本能够完美运行。     </p>
<p>  <img src="http://img.blog.csdn.net/20150208200001890" alt="NineOldAndroids"></p>
<h3 id="2-_总体设计">2. 总体设计</h3>
<p><img src="http://img.blog.csdn.net/20150208200042263" alt="整体设计"><br>   以上是NineoldAnimations的整体设计图,Animator通过PropertyValuesHolder来更新对象的目标属性。如果用户没有设置目标属性的Property对象,那么会通过反射的形式调用目标属性的setter方法来更新属性值;否则则通过Property的set方法来设置属性值。这个属性值则通过KeyFrameSet的计算得到,而KeyFrameSet又是通过时间插值器和类型估值器来计算。在动画执行过程中不断地计算当前时刻目标属性的值,然后更新属性值来达到动画效果。<br>   这篇文章更多的是从整体结构方面介绍NineOldAnimations，如果需要从源码上剖析请参考<a href="http://blog.csdn.net/bboyfeiyu/article/details/39737857" target="_blank" rel="external">NineOldAnimations源码分析</a>.   </p>
<h3 id="2-1_类详细介绍">2.1 类详细介绍</h3>
<p>在进行下一步的分析之前，我们先来了解一下NineOldAndroids中一些核心的类以及它们的作用。    </p>
<ul>
<li><strong>ValueAnimator</strong> :  该类是Animator的子类,实现了动画的整个处理逻辑,也是NineOldAndroids最为核心的类；     </li>
<li><strong>ObjectAnimator</strong>  :  对象属性动画的操作类，继承自ValueAnimator,通过该类使用动画的形式操作对象的属性；                  </li>
<li><strong>TimeInterpolator</strong> : 时间插值器,它的作用是根据时间流逝的百分比来计算出当前属性值改变的百分比，系统预置的有LinearInterpolator（线性插值器：匀速动画）、AccelerateDecelerateInterpolator（加速减速插值器：动画两头慢中间快）和DecelerateInterpolator（减速插值器：动画越来越慢）等；     </li>
<li><strong>TypeEvaluator</strong> :  TypeEvaluator的中文翻译为类型估值算法，它的作用是根据当前属性改变的百分比来计算改变后的属性值，系统预置的有IntEvaluator（针对整型属性）、FloatEvaluator（针对浮点型属性）和ArgbEvaluator（针对Color属性）；     </li>
<li><strong>Property</strong> ： 属性对象,主要是定义了属性的set和get方法；</li>
<li><strong>PropertyValuesHolder</strong> ： PropertyValuesHolder是持有目标属性Property、setter和getter方法、以及关键帧集合的类。</li>
<li><strong>KeyframeSet</strong> ： 存储一个动画的关键帧集合;</li>
<li><strong>AnimationProxy</strong> ： 在API 11以下使用View的属性动画的辅助类。</li>
</ul>
<h3 id="2-2_基本使用">2.2 基本使用</h3>
<p><strong>示例1:</strong><br> 改变一个对象（myObject）的 translationY属性，让其沿着Y轴向上平移一段距离：它的高度，该动画在默认时间内完成，动画的完成时间是可以定义的，想要更灵活的效果我们还可以定义插值器和估值算法，但是一般来说我们不需要自定义，系统已经预置了一些，能够满足常用的动画。 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">ObjectAnimator</span>.<span class="keyword">of</span><span class="variable">Float</span>(my<span class="variable">Object</span>, <span class="string">"translationY"</span>, -my<span class="variable">Object</span>.get<span class="variable">Height</span>()).start();</div></pre></td></tr></table></figure>



<p><strong>示例2:</strong><br>改变一个对象的背景色属性，典型的情形是改变View的背景色，下面的动画可以让背景色在3秒内实现从0xFFFF8080到0xFF8080FF的渐变，并且动画会无限循环而且会有反转的效果。  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ValueAnimator colorAnim = ObjectAnimator.ofInt(<span class="keyword">this</span>, <span class="string">"backgroundColor"</span>, <span class="comment">/*Red*/</span><span class="number">0</span>xFFFF8080, <span class="comment">/*Blue*/</span><span class="number">0</span>xFF8080FF);  </div><div class="line">colorAnim.setDuration(<span class="number">3000</span>);  </div><div class="line">colorAnim.setEvaluator(<span class="keyword">new</span> ArgbEvaluator());  </div><div class="line">colorAnim.setRepeatCount(ValueAnimator.INFINITE);  </div><div class="line">colorAnim.setRepeatMode(ValueAnimator.<span class="keyword">REVERSE</span>);  </div><div class="line">colorAnim.start();</div></pre></td></tr></table></figure>




<p><strong>示例3：</strong><br>动画集合，5秒内对View的旋转、平移、缩放和透明度都进行了改变 。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="variable">AnimatorSet</span> set = new <span class="variable">AnimatorSet</span>();  </div><div class="line">set.play<span class="variable">Together</span>(  </div><div class="line">    <span class="variable">ObjectAnimator</span>.<span class="keyword">of</span><span class="variable">Float</span>(my<span class="variable">View</span>, <span class="string">"rotationX"</span>, <span class="number">0</span>, <span class="number">360</span>),  </div><div class="line">    <span class="variable">ObjectAnimator</span>.<span class="keyword">of</span><span class="variable">Float</span>(my<span class="variable">View</span>, <span class="string">"rotationY"</span>, <span class="number">0</span>, <span class="number">180</span>),  </div><div class="line">    <span class="variable">ObjectAnimator</span>.<span class="keyword">of</span><span class="variable">Float</span>(my<span class="variable">View</span>, <span class="string">"rotation"</span>, <span class="number">0</span>, -<span class="number">90</span>),  </div><div class="line">    <span class="variable">ObjectAnimator</span>.<span class="keyword">of</span><span class="variable">Float</span>(my<span class="variable">View</span>, <span class="string">"translationX"</span>, <span class="number">0</span>, <span class="number">90</span>),  </div><div class="line">    <span class="variable">ObjectAnimator</span>.<span class="keyword">of</span><span class="variable">Float</span>(my<span class="variable">View</span>, <span class="string">"translationY"</span>, <span class="number">0</span>, <span class="number">90</span>),  </div><div class="line">    <span class="variable">ObjectAnimator</span>.<span class="keyword">of</span><span class="variable">Float</span>(my<span class="variable">View</span>, <span class="string">"scaleX"</span>, <span class="number">1</span>, <span class="number">1.5</span>f),  </div><div class="line">    <span class="variable">ObjectAnimator</span>.<span class="keyword">of</span><span class="variable">Float</span>(my<span class="variable">View</span>, <span class="string">"scaleY"</span>, <span class="number">1</span>, <span class="number">0.5</span>f),  </div><div class="line">    <span class="variable">ObjectAnimator</span>.<span class="keyword">of</span><span class="variable">Float</span>(my<span class="variable">View</span>, <span class="string">"alpha"</span>, <span class="number">1</span>, <span class="number">0.25</span>f, <span class="number">1</span>)  </div><div class="line">);  </div><div class="line">set.set<span class="variable">Duration</span>(<span class="number">5</span> * <span class="number">1000</span>).start();</div></pre></td></tr></table></figure>



<p><strong>示例4:</strong><br>下面是个简单的调用方式，其animate方法是nineoldandroids特有的,动画持续时间为2秒,在Y轴上旋转720度,并且平移到(100, 100)的位置。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">Button</span> myButton = (<span class="keyword">Button</span>)findViewById(R.id.myButton);  </div><div class="line">animate(myButton).setDuration(<span class="number">2000</span>).rotationYBy(<span class="number">720</span>).x(<span class="number">100</span>).y(<span class="number">100</span>);</div></pre></td></tr></table></figure>



<p>由于时间关系，上述示例代码引用自<a href="http://blog.csdn.net/singwhatiwanna/article/details/17639987" target="_blank">任玉刚的博客</a>,本人也整理了一份简单的demo，猛击<br><a href="https://github.com/aosp-exchange-group/android-open-project-demo/tree/master/nineoldanimations-demo" target="_blank">Demo地址</a>进入。       </p>
<h3 id="3-_流程图">3. 流程图</h3>
<h4 id="3-1_ValueAnimator流程图">3.1 ValueAnimator流程图</h4>
<p><img src="http://img.blog.csdn.net/20150209102606564" alt="ValueAnimator流程图"></p>
<h4 id="3-2_View的ObjectAnimator流程图">3.2 View的ObjectAnimator流程图</h4>
<p><img src="http://img.blog.csdn.net/20150208200151452" alt="这里写图片描述"></p>
<h3 id="4-_详细设计">4. 详细设计</h3>
<p><img src="http://img.blog.csdn.net/20150208200246192" alt="详细设计">  </p>
<h4 id="4-1_核心原理分析">4.1 核心原理分析</h4>
<h5 id="4-1-1_ValueAnimator-java">4.1.1 ValueAnimator.java</h5>
<p>ObjectAnimator是ValueAnimator的子类,ObjectAnimator负责的是属性动画,但是真正对于动画进行操作的类实际上是ValueAnimator,它定义了nineoldandroids的执行逻辑,是nineoldandroids的核心之一。<br>   启动动画时,会将Animator自身添加到等待执行的动画队列中(sPendingAnimations),然后通过AnimationHandler发送一个ANIMATION_START的消息来通知nineoldandroids启动动画。     </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span>(boolean playBackwards) {</div><div class="line">    <span class="keyword">if</span> (Looper.myLooper() == <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(<span class="string">"Animators may only be run on Looper threads"</span>);</div><div class="line">    }</div><div class="line">  </div><div class="line">  	<span class="comment">// ......</span></div><div class="line">    sPendingAnimations.<span class="keyword">get</span>().add(<span class="keyword">this</span>);</div><div class="line">	<span class="comment">// ...... </span></div><div class="line">   </div><div class="line">    AnimationHandler animationHandler = sAnimationHandler.<span class="keyword">get</span>();</div><div class="line">    <span class="keyword">if</span> (animationHandler == <span class="keyword">null</span>) {</div><div class="line">        animationHandler = <span class="keyword">new</span> AnimationHandler();</div><div class="line">        sAnimationHandler.<span class="keyword">set</span>(animationHandler);</div><div class="line">    }</div><div class="line">    animationHandler.sendEmptyMessage(ANIMATION_START);</div><div class="line">}</div></pre></td></tr></table></figure>



<p>  AnimationHandler是ValueAnimator的内部类,它的职责是处理动画的持续执行。      </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AnimationHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>{</div><div class="line">      <span class="annotation">@Override</span></div><div class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) {</div><div class="line">          <span class="keyword">boolean</span> callAgain = <span class="keyword">true</span>;</div><div class="line">          ArrayList&lt;ValueAnimator&gt; animations = sAnimations.get();</div><div class="line">          ArrayList&lt;ValueAnimator&gt; delayedAnims = sDelayedAnims.get();</div><div class="line">          <span class="keyword">switch</span> (msg.what) {</div><div class="line">              <span class="keyword">case</span> ANIMATION_START:</div><div class="line">                  ArrayList&lt;ValueAnimator&gt; pendingAnimations = sPendingAnimations.get();</div><div class="line">                  <span class="comment">// 启动在等待队列中的动画,然后进入ANIMATION_FRAME进行循环执行 </span></div><div class="line">              <span class="keyword">case</span> ANIMATION_FRAME:</div><div class="line">                  <span class="comment">// 根据启动时间来判断是否启动等待中的动画,如果是已经启动的动画,则根据时间点来计算此刻该动画应该得到的属性值</span></div><div class="line">                  <span class="comment">//,并且跟新属性,如果此时动画没有执行完成,则又会通过发布一个ANIMATION_FRAME消息,使得在此进入到这个代码段,</span></div><div class="line">                  <span class="comment">// 这样就相当于循环执行动画,直到动画完成</span></div><div class="line">          }</div><div class="line">      }</div><div class="line">  }</div></pre></td></tr></table></figure>



<p>   在前文中已经说过,如果是属性动画,且系统低于API 11时会通过矩阵变换的形式来处理属性动画效果;否则会通过set + 属性名的形式调用目标对象的setter方法来达到更新属性值。这个版本兼容问题会在初始化动画时进行处理,处理这个问题的函数在ObjectAnimator的initAnimation中。 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Override</span></div><div class="line"><span class="keyword">void</span> initAnimation() {</div><div class="line">    <span class="keyword">if</span> (!mInitialized) {</div><div class="line">        <span class="comment">//   注意这里，很重要</span></div><div class="line">        <span class="keyword">if</span> ((mProperty == <span class="keyword">null</span>) && AnimatorProxy.NEEDS_PROXY </div><div class="line">        	&& (mTarget <span class="keyword">instanceof</span> View) && PROXY_PROPERTIES.containsKey(mPropertyName)) {</div><div class="line">            setProperty(PROXY_PROPERTIES.get(mPropertyName));</div><div class="line">        }</div><div class="line">        <span class="keyword">int</span> numValues = mValues.length;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValues; ++i) {</div><div class="line">            mValues[i].setupSetterAndGetter(mTarget);</div><div class="line">        }</div><div class="line">        <span class="keyword">super</span>.initAnimation();</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>


<p>   这里进行包装的属性动画主要是View的alpha、缩放、平移、旋转等几个主要动画。如果是其他类型对象,那么会在会通过该对象中的目标属性的setter和getter方法来访问,例如对象类型是一个自定义的MyCustomButton,它有一个属性为myText,用户通过属性动画修改它时就需要定义它的setter和getter方法,比如setMyText和getMyText,这样nineoldanimations就会在动画执行时通过反射来调用setter方法进行更新对象属性。       </p>
<h5 id="4-1-2_ObjectAnimator-java">4.1.2 ObjectAnimator.java</h5>
<p>  ObjectAnimator是属性动画的入口类,用户通过上述一系列的静态工厂函数来构建ObjectAnimator,设置完基本属性之后,用户需要设置动画执行时间、重复模式等其他属性（可选）。<br>   上述几个静态函数中,参数1都是需要动画的目标对象,参数二要操作的属性名称,参数三是目标属性的取值范围,如果传递一个值那么该值就是目标属性的最终值;如果传递的是两个值,那么第一个值为起始值,第二个为最终值。       </p>
<p><strong>(1)主要函数</strong>     </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> ObjectAnimator <span class="title">ofInt</span>(Object target, String propertyName, <span class="keyword">int</span>... values) ;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ObjectAnimator <span class="title">ofInt</span>(T target, Property&lt;T, Integer&gt; property, <span class="keyword">int</span>... values) ;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> ObjectAnimator <span class="title">ofFloat</span>(Object target, String propertyName, <span class="keyword">float</span>... values) ;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; ObjectAnimator <span class="title">ofFloat</span>(T target, Property&lt;T, Float&gt; property,</div><div class="line">        <span class="keyword">float</span>... values) ;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> ObjectAnimator <span class="title">ofObject</span>(Object target, String propertyName,</div><div class="line">        TypeEvaluator evaluator, Object... values) ;</div></pre></td></tr></table></figure>





<h5 id="4-1-3_KeyFrameSet-java">4.1.3  KeyFrameSet.java</h5>
<p>   关键帧集合类在动画运行时会根据流逝的时间因子 ( fraction )和类型估值器来计算当前时间目标属性的最新值,然后将这个值通过反射或者Property的set方法设置给目标对象。下面是获取当前属性值的计算函数。     </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> Object <span class="title">getValue</span>(<span class="keyword">float</span> fraction) {</div><div class="line"></div><div class="line">    <span class="comment">// Special-case optimization for the common case of only two keyframes</span></div><div class="line">    <span class="keyword">if</span> (mNumKeyframes == <span class="number">2</span>) {</div><div class="line">        <span class="keyword">if</span> (mInterpolator != <span class="keyword">null</span>) {</div><div class="line">            fraction = mInterpolator.getInterpolation(fraction);</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> mEvaluator.evaluate(fraction, mFirstKeyframe.getValue(),</div><div class="line">                mLastKeyframe.getValue());</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (fraction &lt;= <span class="number">0</span>f) {</div><div class="line">        <span class="keyword">final</span> Keyframe nextKeyframe = mKeyframes.get(<span class="number">1</span>);</div><div class="line">        <span class="keyword">final</span> <span class="comment">/*Time*/</span>Interpolator interpolator = nextKeyframe.getInterpolator();</div><div class="line">        <span class="keyword">if</span> (interpolator != <span class="keyword">null</span>) {</div><div class="line">            fraction = interpolator.getInterpolation(fraction);</div><div class="line">        }</div><div class="line">        <span class="keyword">final</span> <span class="keyword">float</span> prevFraction = mFirstKeyframe.getFraction();</div><div class="line">        <span class="keyword">float</span> intervalFraction = (fraction - prevFraction) /</div><div class="line">            (nextKeyframe.getFraction() - prevFraction);</div><div class="line">        <span class="keyword">return</span> mEvaluator.evaluate(intervalFraction, mFirstKeyframe.getValue(),</div><div class="line">                nextKeyframe.getValue());</div><div class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (fraction &gt;= <span class="number">1</span>f) {</div><div class="line">        <span class="keyword">final</span> Keyframe prevKeyframe = mKeyframes.get(mNumKeyframes - <span class="number">2</span>);</div><div class="line">        <span class="keyword">final</span> <span class="comment">/*Time*/</span>Interpolator interpolator = mLastKeyframe.getInterpolator();</div><div class="line">        <span class="keyword">if</span> (interpolator != <span class="keyword">null</span>) {</div><div class="line">            fraction = interpolator.getInterpolation(fraction);</div><div class="line">        }</div><div class="line">        <span class="keyword">final</span> <span class="keyword">float</span> prevFraction = prevKeyframe.getFraction();</div><div class="line">        <span class="keyword">float</span> intervalFraction = (fraction - prevFraction) /</div><div class="line">            (mLastKeyframe.getFraction() - prevFraction);</div><div class="line">        <span class="keyword">return</span> mEvaluator.evaluate(intervalFraction, prevKeyframe.getValue(),</div><div class="line">                mLastKeyframe.getValue());</div><div class="line">    }</div><div class="line">    Keyframe prevKeyframe = mFirstKeyframe;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; mNumKeyframes; ++i) {</div><div class="line">        Keyframe nextKeyframe = mKeyframes.get(i);</div><div class="line">        <span class="keyword">if</span> (fraction &lt; nextKeyframe.getFraction()) {</div><div class="line">            <span class="keyword">final</span> <span class="comment">/*Time*/</span>Interpolator interpolator = nextKeyframe.getInterpolator();</div><div class="line">            <span class="keyword">if</span> (interpolator != <span class="keyword">null</span>) {</div><div class="line">                fraction = interpolator.getInterpolation(fraction);</div><div class="line">            }</div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> prevFraction = prevKeyframe.getFraction();</div><div class="line">            <span class="keyword">float</span> intervalFraction = (fraction - prevFraction) /</div><div class="line">                (nextKeyframe.getFraction() - prevFraction);</div><div class="line">            <span class="keyword">return</span> mEvaluator.evaluate(intervalFraction, prevKeyframe.getValue(),</div><div class="line">                    nextKeyframe.getValue());</div><div class="line">        }</div><div class="line">        prevKeyframe = nextKeyframe;</div><div class="line">    }</div><div class="line">    <span class="comment">// shouldn't reach here</span></div><div class="line">    <span class="keyword">return</span> mLastKeyframe.getValue();</div><div class="line">}</div></pre></td></tr></table></figure>




<h5 id="4-1-4_PropertyValuesHolder-java">4.1.4 PropertyValuesHolder.java</h5>
<p>   PropertyValuesHolder是持有目标属性Property、setter和getter方法、以及关键帧集合的类。如果没有属性的mProperty不为空,比如用户使用了内置的Property或者自定义实现了Property,并且设置给了动画类,那么在更新动画时则会使用Property对象的set方法来更新属性值。否则在初始化时PropertyValuesHolder会拼装属性的setter和getter函数 ( 注意这里的setter和上面说的Property对象的set方法是两码事 ) ,然后检测目标对象中是否含有这些方法,如果含有则获取setter和getter。 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">void</span> setupSetter(Class targetClass) {</div><div class="line">       mSetter = setupSetterOrGetter(targetClass, sSetterPropertyMap, <span class="string">"set"</span>, mValueType);</div><div class="line">   }</div><div class="line">   </div><div class="line"><span class="comment">// 通过KeyFrameSet计算属性值</span></div><div class="line">   <span class="keyword">void</span> calculateValue(<span class="keyword">float</span> fraction) {</div><div class="line">       mAnimatedValue = mKeyframeSet.getValue(fraction);</div><div class="line">   }</div><div class="line">   </div><div class="line">   <span class="comment">// ...... </span></div><div class="line">   </div><div class="line">   <span class="keyword">void</span> setAnimatedValue(Object target) {</div><div class="line">       <span class="keyword">if</span> (mProperty != <span class="keyword">null</span>) {</div><div class="line">       	<span class="comment">// 获取新值,并且通过Property的set方法更新值</span></div><div class="line">           mProperty.<span class="keyword">set</span>(target, getAnimatedValue());</div><div class="line">       }</div><div class="line">       <span class="comment">// 如果没有设置Property,那么通过属性的setter来反射调用更新</span></div><div class="line">       <span class="keyword">if</span> (mSetter != <span class="keyword">null</span>) {</div><div class="line">           <span class="keyword">try</span> {</div><div class="line">               mTmpValueArray[<span class="number">0</span>] = getAnimatedValue();</div><div class="line">               mSetter.invoke(target, mTmpValueArray);</div><div class="line">           } <span class="keyword">catch</span> (InvocationTargetException e) {</div><div class="line">               Log.e(<span class="string">"PropertyValuesHolder"</span>, e.toString());</div><div class="line">           } <span class="keyword">catch</span> (IllegalAccessException e) {</div><div class="line">               Log.e(<span class="string">"PropertyValuesHolder"</span>, e.toString());</div><div class="line">           }</div><div class="line">       }</div><div class="line">   }</div></pre></td></tr></table></figure>


<p>   在动画执行时通过关键帧中的插值器和类型估值器来计算最新的属性值( 见calculatVealue函数 ),然后通过反射调用setter方法或者Property对象的set方法设置给目标对象来更新目标属性,循环执行这个过程就实现了动画效果。   </p>
<h3 id="5-_杂谈">5. 杂谈</h3>
<p>NineoldAnimations总得来说还是比较不错的，在开发过程中起到了很大的作用。但是从设计角度上看,它可能并不是特别的好,例如代码中到处充斥着没有进行类型检查的警告,也可能是这个库本身存在太多的可变性,导致难以周全。<br>该项目目前已经标识为DEPRECATED,作者的原意应该是不再更新该库,因为它已经比较稳定,希望朋友们不要误以为是不再建议使用该库的意思。       </p>
  
	</div>
		<footer class="article-footer clearfix">




<div class="article-share" id="share">

  
<div class="jiathis_style">
    <span class="jiathis_txt">分享到：</span>
    <a class="jiathis_button_tsina">新浪微博</a>
    <a class="jiathis_button_weixin">微信</a>
    <a class="jiathis_button_twitter">Twitter</a>
    <a class="jiathis_button_evernote">EverNote</a>
    <a href="http://www.jiathis.com/share?uid=1501277" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
</div>
<script type="text/javascript" >
    var jiathis_config={
    data_track_clickback:true,
    sm:"copy,renren,cqq",
    pic:"",
    summary:"",
    
  </script> 
<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=
" charset="utf-8"></script>      


</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/02/12/reflections/" title="公共技术之 Java反射 Reflection">
  <strong>PREVIOUS:</strong><br/>
  <span>
  公共技术之 Java反射 Reflection</span>
</a>
</div>


</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NineOldAnimations_设计解析"><span class="toc-number">1.</span> <span class="toc-text">NineOldAnimations 设计解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-_功能介绍"><span class="toc-number">1.0.1.</span> <span class="toc-text">1. 功能介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-_总体设计"><span class="toc-number">1.0.2.</span> <span class="toc-text">2. 总体设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1_类详细介绍"><span class="toc-number">1.0.3.</span> <span class="toc-text">2.1 类详细介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2_基本使用"><span class="toc-number">1.0.4.</span> <span class="toc-text">2.2 基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-_流程图"><span class="toc-number">1.0.5.</span> <span class="toc-text">3. 流程图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1_ValueAnimator流程图"><span class="toc-number">1.0.5.1.</span> <span class="toc-text">3.1 ValueAnimator流程图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2_View的ObjectAnimator流程图"><span class="toc-number">1.0.5.2.</span> <span class="toc-text">3.2 View的ObjectAnimator流程图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-_详细设计"><span class="toc-number">1.0.6.</span> <span class="toc-text">4. 详细设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1_核心原理分析"><span class="toc-number">1.0.6.1.</span> <span class="toc-text">4.1 核心原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-1_ValueAnimator-java"><span class="toc-number">1.0.6.1.1.</span> <span class="toc-text">4.1.1 ValueAnimator.java</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2_ObjectAnimator-java"><span class="toc-number">1.0.6.1.2.</span> <span class="toc-text">4.1.2 ObjectAnimator.java</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-3_KeyFrameSet-java"><span class="toc-number">1.0.6.1.3.</span> <span class="toc-text">4.1.3  KeyFrameSet.java</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-4_PropertyValuesHolder-java"><span class="toc-number">1.0.6.1.4.</span> <span class="toc-text">4.1.4 PropertyValuesHolder.java</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-_杂谈"><span class="toc-number">1.0.7.</span> <span class="toc-text">5. 杂谈</span></a></li></ol></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/android/" title="android">android<sup>1</sup></a></li>
		
			<li><a href="/tags/设计模式，Android/" title="设计模式，Android">设计模式，Android<sup>1</sup></a></li>
		
			<li><a href="/tags/面向对象/" title="面向对象">面向对象<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="null" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
		
		<a href="http://www.simplecoder.cn" target="_blank" title="Mr.Simple">Mr.Simple</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"null"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 




<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'null', 'null');  
ga('send', 'pageview');
</script>


  </body>
</html>
